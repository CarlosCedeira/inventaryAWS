SCRIPT SQL – Versión mejorada y modular

--- Esquema SQL simplificado para un MVP SaaS local
-- Tienda online + Inventario + Punto de Venta (multi-tenant básico)
-- Motor: MySQL (InnoDB, utf8mb4)

SET FOREIGN_KEY_CHECKS = 0;

-- =====================================
-- Tabla principal: tenants (negocios / clientes)
-- =====================================

CREATE TABLE tenants (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nombre VARCHAR(150) NOT NULL,
  contacto_email VARCHAR(150) NULL,
  tarifa INT NOT NULL,
  activo BOOLEAN DEFAULT TRUE,
  fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =====================================
-- Usuarios (multi-tenant)
-- =====================================

CREATE TABLE usuarios (
  id INT AUTO_INCREMENT PRIMARY KEY,
  tenant_id INT NOT NULL,
  nombre VARCHAR(150) NOT NULL,
  email VARCHAR(150) NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  rol ENUM('admin','vendedor') DEFAULT 'vendedor',
  activo BOOLEAN DEFAULT TRUE,
  fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
  UNIQUE KEY uq_usuario_email_tenant (tenant_id, email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =====================================
-- Clientes (para pedidos online o POS)
-- =====================================

CREATE TABLE clientes (
  id INT AUTO_INCREMENT PRIMARY KEY,
  tenant_id INT NOT NULL,
  nombre VARCHAR(200) NOT NULL,
  email VARCHAR(150) NULL,
  telefono VARCHAR(50) NULL,
  direccion VARCHAR(255) NULL,
  ciudad VARCHAR(100) NULL,
  provincia VARCHAR(100) NULL,
  codigo_postal VARCHAR(20) NULL,
  pais VARCHAR(100) DEFAULT 'España',
  notas TEXT NULL,
  fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- =====================================
-- Categorías
-- =====================================

CREATE TABLE categorias (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nombre VARCHAR(150) NOT NULL,
  descripcion TEXT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- =====================================
-- Productos
-- =====================================

CREATE TABLE productos (
  id INT AUTO_INCREMENT PRIMARY KEY,
  tenant_id INT NOT NULL,
  nombre VARCHAR(200) NOT NULL,
  descripcion TEXT NULL,
  categoria_id INT,
  publicado BOOLEAN DEFAULT FALSE,
  destacado BOOLEAN DEFAULT FALSE,
  recomendado BOOLEAN DEFAULT FALSE,
  ranking INT DEFAULT 1 CHECK (ranking BETWEEN 1 AND 10),
  fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
  variantes JSON NULL,  -- NUEVO CAMPO
  FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
  FOREIGN KEY (categoria_id) REFERENCES categorias(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;



CREATE TABLE inventario (
  id INT AUTO_INCREMENT PRIMARY KEY,
  tenant_id INT NOT NULL,
  producto_id INT NOT NULL,
  tipo_variante_id INT,
  valor_variante_id INT,
  cantidad INT DEFAULT 0,
  stock_minimo INT DEFAULT 0,
  precio_compra DECIMAL(10,2) DEFAULT 0.00,
  precio_venta DECIMAL(10,2) DEFAULT 0.00,
  fecha_caducidad DATE,
  codigo_barras VARCHAR(100) NULL,
  numero_lote VARCHAR(100) NULL,
  sku VARCHAR(100) NULL,
  ultima_actualizacion DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
  FOREIGN KEY (producto_id) REFERENCES productos(id) ON DELETE CASCADE,
  FOREIGN KEY (tipo_variante_id) REFERENCES tipos_variantes(id) ON DELETE CASCADE,
FOREIGN KEY (valor_variante_id) REFERENCES valores_variantes(id) ON DELETE CASCADE

);

CREATE TABLE inventario_variantes (
  id INT AUTO_INCREMENT PRIMARY KEY,
  id_inventario INT NOT NULL,
  id_valor_variantes INT NOT NULL,
  FOREIGN KEY (id_inventario) REFERENCES inventario(id) ON DELETE CASCADE,
  FOREIGN KEY (id_valor_variantes) REFERENCES valores_variantes(id) ON DELETE CASCADE
);



-- =====================================
-- Imagenes 
-- =====================================

CREATE TABLE imagenes_productos (
  id INT AUTO_INCREMENT PRIMARY KEY,
  producto_id INT,
  tenant_id INT NOT NULL,
  entidad_id INT NOT NULL,
  url_imagen VARCHAR(1000) NOT NULL,
  alt_text VARCHAR(255) NULL,
  es_principal BOOLEAN DEFAULT FALSE,
  orden INT DEFAULT 0,
  fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (producto_id) REFERENCES productos(id) ON DELETE CASCADE,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
  INDEX idx_imagen_entidad (entidad_tipo, entidad_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =====================================
-- Pedidos (tienda online)
-- =====================================

CREATE TABLE pedidos (
  id INT AUTO_INCREMENT PRIMARY KEY,
  tenant_id INT NOT NULL,
  cliente_id INT NULL,
  estado ENUM('pendiente','completado','cancelado') DEFAULT 'pendiente',
  total DECIMAL(12,2) DEFAULT 0.00,
  metodo_pago VARCHAR(100) NULL,
  fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
  FOREIGN KEY (usuario_cliente_id) REFERENCES usuarios(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE pedidos_items (
  id INT AUTO_INCREMENT PRIMARY KEY,
  pedido_id INT NOT NULL,
  producto_id INT NULL,
  nombre VARCHAR(300) NULL,
  cantidad INT NOT NULL,
  precio_unit DECIMAL(10,2) DEFAULT 0.00,
  total DECIMAL(10,2) DEFAULT 0.00,
  FOREIGN KEY (pedido_id) REFERENCES pedidos(id) ON DELETE CASCADE,
  FOREIGN KEY (producto_id) REFERENCES productos(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =====================================
-- Ventas POS (punto de venta simple)
-- =====================================
CREATE TABLE ventas_pos (
  id INT AUTO_INCREMENT PRIMARY KEY,
  tenant_id INT NOT NULL,
  usuario_id INT NULL,
  total DECIMAL(12,2) DEFAULT 0.00,
  metodo_pagoENUM('efectivo','tarjeta'),
  fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
  FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE ventas_pos_items (
  id INT AUTO_INCREMENT PRIMARY KEY,
  venta_pos_id INT NOT NULL,
  producto_id INT NULL,
  nombre VARCHAR(300) NULL,
  cantidad INT NOT NULL,
  precio_unit DECIMAL(10,2) DEFAULT 0.00,
  total DECIMAL(10,2) DEFAULT 0.00,
  FOREIGN KEY (venta_pos_id) REFERENCES ventas_pos(id) ON DELETE CASCADE,
  FOREIGN KEY (producto_id) REFERENCES productos(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =====================================
-- Notas y recomendaciones:
-- 1) MySQL es una buena opción para este MVP (fácil de desplegar y escalar).
-- 2) La multi-tenencia es a nivel de fila (id_tenant en cada tabla).
-- 3) Puedes montar este esquema en un único contenedor local de MySQL sin problemas.
-- 4) Si el proyecto crece, considera pasar a PostgreSQL por sus funciones JSONB y CTE más potentes.